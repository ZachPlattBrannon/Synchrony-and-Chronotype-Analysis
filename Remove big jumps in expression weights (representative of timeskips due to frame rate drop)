# Calculate frame-to-frame change summed across all emotions
df['expr_change'] = df.groupby('subject')[emotion_columns]\
                      .diff().abs().sum(axis=1)

# Set a threshold (global or per team; here we keep it global)
threshold = df['expr_change'].quantile(0.95)

# Flag big jumps
df['big_jump'] = df['expr_change'] > threshold

# Initialize empty list to collect cleaned team data
cleaned_team_data = []

# Loop through each team separately
for team_id, team_data in df.groupby('team'):

    # Find bad frames within this team
    bad_frames = team_data[team_data['big_jump']]['frame'].unique()
    
    # Remove bad frames for all subjects in this team
    team_clean = team_data[~team_data['frame'].isin(bad_frames)].copy()
    
    cleaned_team_data.append(team_clean)

# Concatenate all cleaned teams back together
clean_df = pd.concat(cleaned_team_data_
