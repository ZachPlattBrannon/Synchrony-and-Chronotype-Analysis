# Calculate frame-to-frame change summed across all emotions
df['expr_change'] = df.groupby('subject')[emotion_columns]\
                      .diff().abs().sum(axis=1)

# Set threshold (global across all subjects) or you could do per-subject
threshold = df['expr_change'].quantile(0.95)

# Flag big jumps
df['big_jump'] = df['expr_change'] > threshold

# Now: Find all bad frames across all subjects
bad_frames = df[df['big_jump']]['frame'].unique()

# Remove these bad frames globally for everyone
clean_df = df[~df['frame'].isin(bad_frames)].copy()

print(f"Removed {len(bad_frames)} frames globally due to big expression changes.")
